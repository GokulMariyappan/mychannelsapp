<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>private chat</title>
    <style>
        :root {
        --bg-color: #111b21;
        --chat-bg: #202c33;
        --msg-bg: #2a3942;
        --text-color: #e9edef;
        --accent: #00a884;
        --mine-bg: #005c4b;
        }

        * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        }

        body {
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: "Segoe UI", Roboto, sans-serif;
        display: flex;
        flex-direction: column;
        height: 100vh;
        padding: 10px;
        }

        h1 {
        text-align: center;
        margin-bottom: 10px;
        margin-left: 40px; /* Adjust this to provide space for the arrow */
        font-size: 24px;
        color: var(--accent);
        }

        #chatbox {
        flex: 1;
        overflow-y: auto;
        background-color: var(--chat-bg);
        padding: 15px;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        scroll-behavior: smooth;
        }

        .message {
        padding: 10px 14px;
        border-radius: 10px;
        max-width: 70%;
        word-wrap: break-word;
        animation: fadeInUp 0.3s ease-out forwards;
        }

        .mine {
        align-self: flex-end;
        background-color: var(--mine-bg);
        text-align: right;
        }

        .other {
        align-self: flex-start;
        background-color: var(--msg-bg);
        text-align: left;
        }

        .message b {
        color: var(--accent);
        }

        form {
        margin-top: 10px;
        display: flex;
        gap: 10px;
        align-items: center;
        background-color: var(--chat-bg);
        padding: 10px;
        border-radius: 8px;
        }

        input[type="text"],
        textarea,
        input[name="message"] {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        background-color: #111;
        color: var(--text-color);
        resize: none;
        height: 40px;
        }

        button {
        background-color: var(--accent);
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 16px;
        cursor: pointer;
        transition: background 0.3s ease;
        }

        button:hover {
        background-color: #019276;
        }

        @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
        }

        @media (max-width: 600px) {
        h1 {
            font-size: 18px;
        }

        .message {
            font-size: 14px;
        }

        button {
            width: 36px;
            height: 36px;
        }
        }

        label {
        color: var(--accent);
        font-weight: bold;
        margin-right: 10px;
        font-size: 15px;
        }

        .header-container {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        position: relative;
        padding: 10px;
        }

        .back-arrow-container {
        position: absolute;
        left: 10px; /* Adjust this to position it in the leftmost corner */
        }

        .back-arrow {
        cursor: pointer;
        color: var(--accent); /* Adjust the color */
        transition: transform 0.2s ease;
        }

        .back-arrow:hover {
        transform: scale(1.1);
        }

        .file-thumbnail {
            width: 180px;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            transition: transform 0.2s ease;
            }

            .file-thumbnail:hover {
            transform: scale(1.02);
            }

            .attachment-bubble {
            display: inline-block;
            /* margin-bottom: 8px; */
            min-width: 180px;
            max-width: 80%;
            padding: 6px;
            background: #005c4b; 
            border-radius: 10px;
            text-align: center;
            }
            
            .otherfile{
              background-color: var(--msg-bg);
            }

            .message.other .attachment-bubble {
            background: #ffffff; 
            }

            .file-name {
            margin-top: 4px;
            font-size: 0.9rem;
            color: #e9edef;
            word-break: break-word;
            }

            #file_label {
              cursor: pointer;
            }

            #file_label .clip-icon {
              transition: stroke 0.2s ease, transform 0.2s ease;
            }

            #file_label:hover .clip-icon {
              stroke: #bbbbbb; /* Light gray on hover */
              transform: rotate(135deg) scale(1.1);
            }

    </style>
</head>
<body>
    <div class="header-container">
        <a class="back-arrow-container" href="{% url "dbchat:homepage" %}">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" class="back-arrow" viewBox="0 0 24 24">
            <path d="M19 12H5m7 7l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>
        <h1>{{ second_user }} ðŸ˜Ž</h1>
      </div>
    <input type = "hidden" id  = "second_user" value = "{{ second_user.id }}">
    {% if error %}
        <p>{{error}}</p>
    {% endif %}
    
    <section id = 'chatbox'>
        {%  if messages %}
            {% for message in messages reversed %}
                {% if message.user == user %}
                    {% if message.files %}
                        <div class="message mine attachment-bubble">
                            <a target="_blank" href="{{ message.files.url }}">
                            <img src="/media/fileattachment.jpg" alt="File Attachment" class="file-thumbnail">
                            </a>
                            <div class="file-name">{{ message.files.name }}</div>
                        </div>
                    {% endif %}
                    {% if message.image %}
                        <div class="image mine">
                            <img src="{{ message.image.url }}" alt="image" class="imageObject"/>
                        </div>
                    {% endif %}
                    {% if message.message %}
                        <p class = 'message mine'><b>me: </b>{{ message.message }}</p>
                    {% endif %}
                {% else %}
                    {% if message.files %}
                        <div class="message other attachment-bubble otherfile">
                            <a target="_blank" href="{{ message.files.url }}">
                            <img src="/media/fileattachment.jpg" alt="File Attachment" class="file-thumbnail">
                            </a>
                            <div class="file-name">{{ message.files.name }}</div>
                        </div>
                    {% endif %}
                    {% if message.image %}
                        <div class="image other">
                            <img src="{{ message.image.url }}" alt="image" class="imageObject"/>
                        </div>
                    {% endif %}
                    {% if message.message %}
                        <p class = 'message other'><b>{{ message.user }}: </b>{{ message.message }}</p>
                    {% endif %}
                {% endif %}
            {% endfor %}
        {% else %}
        <p>Start Convo!</p>
        {% endif %}
    </section>
    <form id = 'form' novalidate method = "POST">
        {% csrf_token %}
        <label for="id_message">Message</label>
        {{ form.message }}
        <label for="id_files" id="file_label">
            <svg xmlns="http://www.w3.org/2000/svg"
                 width="44" height="30"
                 viewBox="0 0 24 24"
                 fill="none" stroke="white"
                 stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                 class="clip-icon"
                 style="transform: rotate(135deg); transform-origin: center;">
              <path d="M16.5 6.5l-7.8 7.8a3 3 0 104.2 4.2l8.2-8.2a5 5 0 10-7.1-7.1L4.9 12.9a7 7 0 109.9 9.9l10.1-10.1"/>
            </svg>
          </label>        
        <input type = "file" name = "files" id = "id_files" style="display: none;"/>
        <button onclick = "sendMessage()">â–¶</button>
    </form>
    <script>
        document.getElementById('form').addEventListener('submit', (event) => {
            event.preventDefault();
        });
        let chatbox = document.getElementById('chatbox');
        let ws = new WebSocket(`ws://${window.location.host}/private_chat/${document.getElementById("second_user").value}/`);

        function scrollToBottom() {
            chatbox.scrollTop = chatbox.scrollHeight;
        }

        window.onload = scrollToBottom;

        ws.onmessage = (event) => {
            let data = JSON.parse(event.data);
            console.log(data);
            if(data.type === 'websocket_response'){
                console.log("we are here");
                if(data.file){
                    let attachdiv = document.createElement('div');
                    if(data.sender !== 'Me'){
                        attachdiv.className = 'message other attachment-bubble otherfile';
                    }else{
                        attachdiv.className = 'message mine attachment-bubble';
                    }
                    let a = document.createElement('a');
                    a.target = '_blank';
                    a.href = `/media/${data.file}`;
                    let image = document.createElement('img');
                    image.src = '/media/fileattachment.jpg';
                    image.alt = 'FileAttachmentðŸ“Ž'
                    image.className = 'file-thumbnail';
                    a.appendChild(image);
                    let div = document.createElement('div');
                    div.className = 'file-name';
                    div.innerText = data.file;
                    attachdiv.appendChild(a);
                    attachdiv.appendChild(div);
                    chatbox.appendChild(attachdiv);
                }
                if(data.image){
                    let div = document.createElement('div');
                    let image = document.createElement('img');
                    image.src = `/media/${data.image}`;
                    image.className = 'imageObject';
                    image.alt = 'image';
                    if(data.sender !== 'Me'){
                        div.className = 'image other';
                    }else{
                        div.className = 'image mine';
                    }
                    div.appendChild(image);
                    chatbox.appendChild(div);
                }
                if(data.message){
                    let message = document.createElement('p');
                    message.className = 'message';
                    let sender = document.createElement('b');
                    sender.innerText = `${data.sender}: `;
                    if(data.sender !== 'Me'){
                        message.classList.add('other');
                    }else{
                        message.classList.add('mine');
                    }
                    message.appendChild(sender);
                    message.append(data.message);
                    chatbox.appendChild(message); 
                }
                scrollToBottom();
            }
        }

        async function sendMessage(){

            async function readFileAsBase64(file) {
                return await new Promise((resolve, reject) => {
                    const reader = new FileReader();

                    reader.onload = () => {
                        const base64 = reader.result.split(',')[1];
                        resolve(base64);
                    };

                    reader.onerror = () => {
                        reject("Failed to read file.");
                    };

                    reader.readAsDataURL(file);
                });
            }

            let message = document.getElementById('id_message');
            message = message.value ? message.value : null;
            let file = document.getElementById('id_files');
            let bool = file.files.length > 0;
            let filename, fileType;
            if(bool){
                filename = file.files[0].name;
                fileType = file.files[0].type;
            }
            if(file.files.length > 0){
                console.log('reading file');
                file = file.files[0];
                file = await readFileAsBase64(file);
                console.log(file);
            }else{
                file = null;
            }

            ws.send(JSON.stringify({'message' : message, 'file' : bool,  'fileData': file, 'filename' : filename, 'filetype' :  fileType}));
            document.getElementById('id_message').value = '';
            document.getElementById('id_files').value = '';
            scrollToBottom();
        }
    </script>
</body>
</html>